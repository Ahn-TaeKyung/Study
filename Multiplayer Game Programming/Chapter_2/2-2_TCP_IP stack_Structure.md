# TCP/IP 스택의 게층 구조

TCP/IP 스택은 일견 우아해 보이기도 하지만 가까이서 보면 여기저기 땜질한 자국도 많이 보인다.
먼저 우아한 면은, 목적에 따라 여러 프로토콜을 갈아 끼울 수있게 계층을 추상화하여 나누고, 각 계층이 저마다 소임에 충실할 수 있게끔 설계하여, 이처럼 각기 독립된 계층이 다른 계층을 뒷받침하고 데이터를 적절히 연계할 수 있다는 면이다.
지저분함 면은 기껏 이렇게 추상화를 잘해놓고선 프로토콜 작성자마다 성능이니 확장성이니 하는 핑계로, 쓸모 있긴 하지만 설계 철학에 반하는 복잡한 예외사항으로 범벅을 해 두었다는 면이다.

멀티플레이어 게임 프로그래머로서 우리는 TCP/IP 스택의 이처럼 우아하면서도 지저분한 일면을 바르게 이해하여, 우리 게임이 제대로 동작하고 또한 효율적으로 동작하게 만들어야 한다. 
게임 제작에는 주로 TCP/IP의 상위 계층을 주로 다루게 되지만, 최적화를 위해서는 하위 게층이 어떻게 동작하는지, 그리고 윗단과 어떤 식으로 상호작용하는지도 알아두면 좋다.

인터넷 통신의 계층 간 상호작용을 설명하는 모델에는 여러 종류가 있다.
초기 인터넷 호스트 요구 사항을 정의한 RFC 1122에선 링크 계층, IP계층, 전송 계층, 응용 계층, 이렇게 네 개의 계층으로 구분한다.
한편 'OSI 7계층'이라 하여 OSI *(Open Systems Interconnection)* 모형에서는 물리 계층, 데이터 링크 계층, 네트워크 계층, 전송 계층, 세션 계층, 표현 계층, 응용 계층, 이렇게 일곱 계층으로 구분한다.
이 책에선 게임 개발과 관련이 있는 것으로 몇몇을 묶어 아래 그림과 같이 다섯 계층으로 구분하여, 물리 계층, 링크 계층, 네트워크 계층, 전송 계층, 응용 계층으로 하겠다. 
각 계층은 저마다 자기 윗단 계층을 지원하기 위해 수행해야 하는 역할이 있다.

- 윗단 계층에서 데이터 블록을 수신한다.
- 게층 헤더를 추가해 패킷을 꾸린다. *(필요시 푸터도 추가한다)*
- 데이터를 아랫단 계층으로 전달해 송신 과정을 계속해 나간다.
- 아랫단 계층에서 수신된 데이터를 받는다.
- 헤더를 제거하여 수신된 데이터의 패킷을 푼다.
- 수신된 데이터를 윗단 계층으로 전달해 수신 처리를 계속해 나간다.

그렇지만 각 계층이 구체적으로 어떤 식으로 역할을 수행해야 하는지 정해져 있는 것은 아니다.
각 계층마다 다양한 프로토콜이 있어 그중 하나로 역할을 수행하는데, 개중엔 TCP/IP처럼 오래된 것도 있고 또 어떤 건 최근 새로 발명된 것도 있다.
객체 지향 개념에 익숙하다면 계층을 인터페이스라 여기고, 각 프로토콜이나 프로토콜 집합은 그 인터페이스를 구체화한 구현물이라 생각해도 좋다.
계층 하나의 구현 방식에 대한 상세한 내용을 추상화하여 그 윗단에서 볼 필요 없도록 감춰두는 것이 이상적일 터이지만, 현실이 그렇지 않다는 것을 이미 언급한 바 있다.
앞으로 각 계층을 개략적으로 살펴보고 가장 널리 이용되는 일반적인 프로토콜은 무엇인지 알아보자.

<img src="https://github.com/user-attachments/assets/cdff9f52-6a40-45eb-83eb-f26f124e7fd6" width="500">
